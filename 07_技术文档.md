# 违约客户管理系统 技术文档（v2.2）

本文面向开发与运维，系统性说明架构设计、数据模型、权限模型、业务流程、存储/审计、配置、测试与部署、API 概览与故障排查。

## 1. 架构概览
- 前端：React + Vite + TypeScript + Ant Design + Axios
- 后端：FastAPI + SQLAlchemy + Alembic + JWT（OAuth2 Password）
- 数据库：SQLite（开发）/ PostgreSQL（生产）
- 对象存储：本地文件系统（/uploads）或 S3 兼容后端（MinIO/AWS S3）
- 鉴权：基于角色的访问控制（RBAC）：Admin / Reviewer / Operator
- 审计：统一中间件与审计写入，记录 actor、action、resource、IP、时间戳

目录关键模块：
- 后端应用：`app/main.py`（入口与中间件）、`app/routers/*`（按域路由）、`app/models.py`、`app/schemas.py`、`app/security.py`、`app/deps.py`、`app/storage.py`、`app/audit.py`
- 前端应用：`frontend/src/pages/*`（功能页）、`frontend/src/stores/auth.ts`（登录态）
- 迁移与构建：`alembic/*`、`Dockerfile`、`docker-compose.yml`、`Makefile`

## 2. 数据模型（主表）
- users：用户（email, hashed_password, role, is_active, created_at）
- customers：客户（name 唯一，industry，region，is_default=是否违约）
- reasons：原因（type=DEFAULT|REBIRTH，description，enabled，sort_order）
- applications：申请（type、customer_id、reason_id、severity、rating、remark、status=PENDING|APPROVED|REJECTED、created_by、reviewed_by、时间戳）
- application_attachments：申请附件（application_id、filename、url、uploaded_at）
- audit_logs：审计（user_id、action、target_type、target_id、details、ip、created_at）
- notifications：通知（user_id、content、is_read、created_at）

关系要点：
- customers.is_default 与申请审核联动：DEFAULT 审核通过 -> True；REBIRTH 审核通过 -> False
- reasons.type 与 applications.type 必须匹配

## 3. 权限模型（RBAC）与资源级规则
- Admin：系统管理（用户、原因、客户、申请的增删改、审核、统计、审计）
- Reviewer：仅审核（查看全部申请，执行同意/拒绝）
- Operator：发起申请、管理自己申请的附件，仅能看到自己的申请

资源级限制：
- Applications 列表/检索：Operator 仅看到自己创建的；Reviewer/Admin 看到全部
- 附件上传/列表/预签名：仅创建人或 Admin，且申请状态为 PENDING
- 客户改名仅 Admin（唯一性校验）；Operator 不可改名

## 4. 业务流程
1) 违约原因维护（Admin）
   - 维护 DEFAULT/REBIRTH 原因，含启用与排序；系统首次启动会种子写入一组常用原因
2) 违约认定申请（Operator/Admin）
   - 必填：客户、原因；severity/rating/remark 选填
   - DEFAULT 仅允许“非违约客户”；REBIRTH 仅允许“已违约客户”；原因类型需与申请类型匹配
   - 可在发起时选择附件（前端已支持多文件选择）
3) 违约认定审核（Reviewer/Admin）
   - PENDING -> APPROVED/REJECTED；通过后联动 customers.is_default
   - 审核不再强制附件存在（可选）；通知申请人结果
4) 违约重生（REBIRTH）与审核
   - 仅对已违约客户发起；规则同上
5) 统计
   - /stats/industry 与 /stats/region 支持 year 与 detailed 模式（占比与 12 个月趋势）

## 5. 存储与文件服务
- local：写入 `uploads/`，通过 FastAPI StaticFiles 挂载 `/files` 直接访问
- s3：写入桶，返回公共基址或 key；下载通过预签名 URL（/attachments/presign）

## 6. 审计日志
- 登录、创建、审核、上传、管理员更新/删除等动作写入审计
- 查询接口（Admin）：支持条件筛选与友好化输出（actor、resource、ip）

## 7. 配置与环境（.env）
- 数据库：`DATABASE_URL`（默认支持 PostgreSQL/SQLite）
- JWT：`JWT_SECRET_KEY`、`JWT_ALGORITHM`、`ACCESS_TOKEN_EXPIRE_MINUTES`
- 初始账号（自动种子且幂等）：`ADMIN_DEFAULT_EMAIL/PASSWORD`、`REVIEWER_*`、`OPERATOR_*`
- 存储：`STORAGE_BACKEND=local|s3` 及 `S3_ENDPOINT/S3_BUCKET/AWS_ACCESS_KEY_ID/AWS_SECRET_ACCESS_KEY/S3_REGION`

## 8. 迁移与初始化
- 启动时优先运行 Alembic 迁移；无迁移时回落到 metadata.create_all（开发场景）
- 首次空库：自动插入基础原因与三类初始用户（Admin/Reviewer/Operator）

## 9. 测试策略
- 后端：pytest 用例覆盖登录、RBAC、申请与审核、附件、统计、审计、边界条件
- 前端：功能页基本交互可通过 Playwright 扩展（目前提供可运行构建与组件）

## 10. 部署与运行
- 本地开发：
  - 后端：uv/venv 启动 FastAPI；SQLite 默认 `./dev.db`
  - 前端：Vite dev server 代理到后端 `/api`
- 生产部署：
  - PostgreSQL + S3/MinIO；使用 docker-compose 一键启动或独立容器编排

## 11. API 概览（详细见 `API.md`）
- 身份：`POST /auth/token`，`GET /users/me`
- 用户（Admin）：CRUD
- 客户：CRUD（改名仅 Admin）
- 原因（Admin）：CRUD；查询全员可用
- 申请：创建、列表/检索（富信息）、详情、审核（Reviewer/Admin）、附件上传/列表/预签名；Admin 可更新/删除申请
- 统计：`/stats/industry`、`/stats/region`（支持 detailed）
- 审计（Admin）：查询

## 12. 安全与合规
- JWT：短时令牌（默认 60 分钟），HTTPS 部署、前端仅存储于 localStorage（可结合刷新令牌策略扩展）
- 密码：bcrypt 哈希；初始口令建议部署后修改
- RBAC：后端强制鉴权与角色校验，前端仅作菜单过滤
- 文件：上传 MIME 校验可按需增强，S3 使用预签名下载

## 13. 性能与扩展
- SQL 聚合：统计月度使用方言适配（SQLite strftime / Postgres to_char）
- 列表分页：可在查询接口添加分页参数与索引
- 缓存：统计结果与原因列表可做缓存层（如 Redis）

## 14. 故障排查
- 登录 401：
  - 确认 `.env` 初始账号已加载（容器重启/进程重启），数据库连接成功
  - 数据库内是否已有对应 email 用户且密码被手工改动；可用 Admin 在“用户”页重置
- `/users/me` 422：
  - 路由顺序问题已修复（先注册 `/users/me`，再注册 `/{id}`）；确保后端已更新并重启
- 附件上传失败：
  - 仅申请创建人或 Admin 且在 PENDING 状态才可上传
  - local 模式检查 `uploads/` 可写；s3 模式检查 Endpoint/Bucket/AK/SK/Region
- 统计为空：
  - 仅统计已审核通过记录（status=APPROVED 且 reviewed_at 在当年区间）

—— 完 ——
